# Stage 1: Builder (dependencies only)
FROM python:3.9-slim as builder

WORKDIR /app
COPY requirements.txt .

# Install CPU-only PyTorch & deps (optimized layers)
RUN pip install --user \
    torch>=2.6.0 --index-url https://download.pytorch.org/whl/cpu \
    && pip install --user -r requirements.txt

# Stage 2: Runtime (ultra-slim)
FROM python:3.9-slim
WORKDIR /app

# Copy ONLY what's needed
COPY --from=builder /root/.local /root/.local
COPY . .

# Set PATH and permissions
ENV PATH=/root/.local/bin:$PATH
# RUN chmod +x ./scripts/*.sh  # If scripts exist

# Run FastAPI with auto-reload (dev mode)
CMD ["uvicorn", "app.main:app","--port", "8000", "--reload"]